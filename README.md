# Spring Boot Linux Packager

This script collection will create:
 - a [RPM package](#how-to-rpms)
 - a [Windows self installer](#how-to-exes) (via [NSIS](https://sourceforge.net/projects/nsis/) and [WinSW](https://github.com/winsw/winsw))

For a **Spring Boot** project, runned as service, and build npm/front during packaging.

Via _bash_, on Linux (RHEL/Debian) and Windows/WSL, not tested on macOS.

## Spring Boot options and prerequisites

 - The builded project must be managed by `Maven`
 - It needs the _Spring Boot maven plugin_ (you should use starter parent project).
 - With `log4j2`. It will provided ready-to-use `log4j2.xml` configuration file.

Your **pom.xml** file, or its ancestors (via `help:effective-pom`), **MUST** define this parameters to provide some informations to put in scripts, installers, and autogenerated man file:

 - `project/version`
 - `project/groupId`
 - `project/artifactId`
 - `project/name`
 - `project/description`
 - `project/url`
 - `project/organization/name`
 - `project/organization/url`
 - `project/licenses/license/name`
 - `project/developers/developer/name`
 - `project/developers/developer/email`
 - `project/issueManagement/system`
 - `project/issueManagement/url`

And should strongly define:
 - `project/properties/java.version`
 - `project/packaging`

Optionally, with persistence (not for Windows). If persistence, it will use _Liquibase_ with [``setupdb-maven-plugin``](https://github.com/hdsdi3g/setupdb-maven-plugin) on Maven project.

Optionally with `npm`, only if your project have a `package.json` file on main dir, [see below](#frontnpm-setup).

Optionally, you project should have a `LICENCE(|.txt|.TXT)` file on its root path.

Optionally, you project can have a `THIRD-PARTY.txt` file, autogenerated by `org.codehaus.mojo/license-maven-plugin`.

## How to RPMs

You will need, in addition to `maven` and `java`:
 - `realpath`
 - `basename`
 - `rpmbuild`
 - `rpmlint`
 - `pandoc`
 - `xmlstarlet`

To make an RPM file. Usage:

```bash
make-rpm <your Spring Boot project path, can be relative from here>
```

With options (`export`):
 - `SKIP_IMPORT_POM=1` for _skip_ to compute full pom XML file if a temp version exists
 - `SKIP_BUILD=1` for _skip_ maven build if the expected `jar` exists.
 - `SKIP_NPM=1` for _skip_ npm builds, even if a `package.json` is founded.
 - `SKIP_CLEAN=1` for _skip_ clean temp files/directories after build.
 - `SKIP_MAKE=1` for _skip_ to make the `RPM` file, just let ready to build.

Maven will be used with _skip tests_, _GPG sign_, _jar javadoc_ and _source packaging_ options.

### Install the RPM files

The builded RPM will run some install/uninstall scripts and do a few things, apart from that, it's a classic, non-signed RPM file.

The setup script check the presence of `bash`, `man`, `useradd`, and `systemctl`, and will deploy:
 - A man file ([template here](src/template-man.md)), as `man artifactId`
 - some example files:
   - An configuration file (`application.yml`)
   - An configuration log file (`log4j2.xml`)
   - An default file
 - The application `jar` file
 - A `Systemd` service file, deployed, ready to run
 - THIRD-PARTY and LICENCE files if available.
 - The Liquibase upgrade file and deploy script, if needed.
 - An user/group and home dir for this user, as service name, to run the created service.
 - A log directory ready to get log files

All templates are in the `src` directory.

Java presence will _not be_ checked by the installer. The default service file will expect to found it in `/usr/bin/java`. Change it as you what after setup.

Before deploy files, the service will be stopped (if exists and if running). After deploy files, it will be enabled, at boot, but not started.

Run the setup with:

```bash
# Install / upgrade
sudo rpm -U <artifactid-version.rpm>

# Remove
sudo rpm -e <artifactid>

# Remove "all"
sudo rpm -e --allmatches <artifactid>
```

You can run manually with like:

```bash
runuser -u <SERVICE_NAME> -- java -Dlogging.config=/etc/<SERVICE_NAME>/log4j2.xml -jar /usr/lib/<SERVICE_NAME>/Spring Boot.jar --spring.config.location=/etc/<SERVICE_NAME>/application.yml
```

## How to EXEs

You will need:
- [NSIS 3+ version](https://sourceforge.net/projects/nsis/), or via `apt-get install nsis`, only for build Windows executables installers.
- [WinSW 2+](https://github.com/winsw/winsw/releases), only for handled Windows services. Executable must be put on the `src` directory.

### Windows setup

Just run setup files with admin rights. If you use WinSW with a _.NET_ dependency, you should install it before.

Actually, Liquibase is not managed.

Executable files, and uninstaller will be placed on `C:\Program Files\<project name>`, and "variable files" like log and application.yml in `C:\ProgramData\<project name>`.

An uninstall script add an entry in "Add/Remove programs" is setup.

Setup script are crafted to be simply "over installed": the next setup will uninstall the previous one (with a service stop and remove), but keep the actual "variable files".

By default, the service run will need a valid `application.yml` and `log4j2.xml`. Samples/examples are provided.

After the setup, with the help of WinSW, a Windows service in declared, but not started and set to Manual.

Free feel to edit `servicewinsw.xml` before build the setup, or edit the production file `winsw.xml`. Please to refer to WinSW documentation.

Don't forget to setup a compatible JVM, and put java.exe directory in PATH.

## Front/npm setup

It will only run `npm install` before start maven package, only if a `package.json` is founded on the main project directory.

On builded project side, `npm install` _should_ run an `webpack` for a **production ready version front app** (minified, etc), and _should_ put finals files on `src/main/resources/static`. Maven and Spring Boot will collects these files during back building.

No checks will be done on this project.

## Constants file

Before run scripts, the `src/tools/consts.bash` will be loaded. It setup some vars and declare the base choices.

In the `src/tools/project.bash`, `def_files_dir_vars()` function, you will see all directories and file names used to build scripts.

### Exit codes

| Error name                                 | Exit code |
| ------------------------------------------ | --------- |
| EXIT_CODE_MISSING_DEPENDENCY_COMMAND       | 1         |
| EXIT_CODE_MISSING_PROJECT                  | 2         |
| EXIT_CODE_MISSING_PROJECT_DIR              | 3         |
| EXIT_CODE_MISSING_POM                      | 4         |
| EXIT_CODE_MISSING_POM_ENTRY                | 5         |
| EXIT_CODE_CANT_FOUND_JAR_FILE_OUTPUT       | 6         |
| EXIT_CODE_CANT_FOUND_LIQUIBASE_FILE_OUTPUT | 7         |
| EXIT_CODE_CANT_FOUND_DEFAULT_CONF          | 8         |
| EXIT_CODE_CANT_FOUND_LOG_CONF              | 9         |
| EXIT_CODE_CANT_FOUND_RPM_FILE_OUTPUT       | 10        |

## Clean

Do a

```bash
./clean-all.bash
```

To remove all temp files.

## Roadmap dev

Like for the [linux-app-packager](https://github.com/hdsdi3g/linux-app-packager) project, free feel to add corrections and/or new features (it's really not rocket science).

On day, **DEB** files will be added, like RPM here.
